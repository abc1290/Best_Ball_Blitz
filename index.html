<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Team Selector & Tee Assignment</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        h1, h2, h3 {
            color: #2d5d2a;
        }
        
        .container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-section, .team-selection, .teams-display, .tee-assignment {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .input-section {
            flex: 1;
        }
        
        .groups-display {
            flex: 1;
        }
        
        .team-selection {
            flex: 1;
        }
        
        .teams-display, .tee-assignment {
            width: 100%;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"], input[type="number"], input[type="time"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .input-invalid {
            border-color: #dc3545;
        }
        
        .validation-feedback {
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 5px;
            min-height: 1em;
        }
        
        button {
            background-color: #3a803a;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        button:hover {
            background-color: #2d632d;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        button:focus {
            outline: 2px solid #4a94a8;
            outline-offset: 2px;
        }
        
        .player-list {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .group-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .group {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        
        .group h3 {
            text-align: center;
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #2d5d2a;
        }
        
        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .team-card {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
        }
        
        .team-card h3 {
            text-align: center;
            margin-top: 0;
            border-bottom: 2px solid #2d5d2a;
            padding-bottom: 5px;
        }
        
        .team-member {
            margin: 8px 0;
            padding: 5px;
            background-color: #ffffff;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .team-stats {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
            font-size: 0.9em;
            color: #666;
        }
        
        .highlight {
            background-color: #e6f7e6;
            animation: highlight 1s ease-in-out;
        }
        
        @keyframes highlight {
            0% { background-color: #c8e6c9; }
            100% { background-color: #e6f7e6; }
        }
        
        .remove-btn {
            background-color: #dc3545;
            margin-left: 5px;
            padding: 2px 5px;
            font-size: 12px;
        }
        
        .remove-btn:hover {
            background-color: #c82333;
        }
        
        .selection-animation {
            height: 150px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .selection-slot {
            width: 80px;
            height: 80px;
            border: 2px solid #2d5d2a;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .selecting {
            box-shadow: 0 0 20px rgba(58, 128, 58, 0.8);
            transform: scale(1.1);
        }
        
        .file-input {
            margin-bottom: 15px;
        }
        
        #errorMessages {
            color: #dc3545;
            margin-bottom: 10px;
        }
        
        .stats {
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #ddd;
            border: none;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        
        .tab-button.active {
            background-color: #3a803a;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .hole-box {
            display: inline-block;
            width: 60px;
            height: 80px;
            border: 2px solid #2d5d2a;
            border-radius: 8px;
            margin: 5px;
            text-align: center;
            vertical-align: top;
            overflow: hidden;
            background-color: white;
            position: relative;
        }
        
        .hole-number {
            background-color: #2d5d2a;
            color: white;
            font-weight: bold;
            padding: 5px 0;
        }
        
        .double-stacked {
            background-color: #c8e6c9;
        }
        
        .hole-team {
            font-size: 12px;
            padding: 3px;
            cursor: pointer;
        }
        
        .hole-team:hover {
            background-color: #f0f0f0;
        }
        
        .course-layout {
            margin-top: 20px;
            text-align: center;
        }
        
        .assign-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
        }
        
        .unassigned-teams {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .unassigned-team {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .unassigned-team:hover {
            background-color: #e6f7e6;
        }
        
        .unassigned-team.selected {
            background-color: #c8e6c9;
            border-color: #3a803a;
        }
        
        .tee-sheet-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .tee-sheet-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .tee-sheet-table th, .tee-sheet-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .tee-sheet-table th {
            background-color: #2d5d2a;
            color: white;
        }
        
        .tee-sheet-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .print-button {
            margin-top: 20px;
            background-color: #2d5d2a;
        }
        
        #teeAssignmentTab {
            padding-bottom: 50px;
        }
        
        .help-tooltip {
            display: inline-block;
            position: relative;
            margin-left: 5px;
            width: 18px;
            height: 18px;
            background-color: #3a803a;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
        }
        
        .help-tooltip .help-text {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .help-tooltip:hover .help-text {
            visibility: visible;
            opacity: 1;
        }
        
        .switch-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3a803a;
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px #3a803a;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .tee-time-settings {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .tee-time-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .tee-time-field {
            flex: 1;
            min-width: 200px;
        }
        
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tutorial-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .tutorial-step {
            margin-bottom: 20px;
        }
        
        .tutorial-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .tutorial-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
        }
        
        /* New styles for pairing party enhancements */
        
        .selection-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .selection-drum {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 40px 0;
        }
        
        .selection-slot-large {
            width: 150px;
            height: 150px;
            margin: 0 20px;
            border: 4px solid #3a803a;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white;
            font-weight: bold;
            font-size: 30px;
            color: #333;
            transition: all 0.5s ease;
        }
        
        .selected-player {
            font-size: 24px;
            margin: 8px 0;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }
        
        .selected-player.reveal {
            opacity: 1;
            transform: translateY(0);
        }
        
        .team-summary {
            margin-top: 30px;
            padding: 20px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 10px;
            text-align: center;
        }
        
        .tournament-bracket-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: auto;
            padding: 20px;
        }
        
        .tournament-bracket-container h2 {
            font-size: 32px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .bracket {
            display: flex;
            max-width: 100%;
            overflow-x: auto;
            padding: 20px;
        }
        
        .round {
            display: flex;
            flex-direction: column;
            margin: 0 20px;
            min-width: 200px;
        }
        
        .round h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #90EE90;
        }
        
        .match {
            display: flex;
            flex-direction: column;
            margin: 10px 0;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .team {
            padding: 10px 15px;
            background-color: rgba(58, 128, 58, 0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .team:last-child {
            border-bottom: none;
        }
        
        .close-bracket-btn {
            margin-top: 30px;
            padding: 10px 20px;
            background-color: #3a803a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .show-bracket-btn {
            margin-top: 20px;
            background-color: #3a803a;
        }
        
        .party-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .group-container {
                flex-direction: column;
            }
            
            .teams-grid {
                grid-template-columns: 1fr;
            }
            
            .tee-time-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .tee-time-field {
                width: 100%;
            }
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .tee-sheet-container, .tee-sheet-container * {
                visibility: visible;
            }
            .tee-sheet-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .print-button {
                display: none;
            }
        }
    </style>
</head>
<body>
    <h1>Golf Team Selector & Tee Assignment</h1>
    
    <div class="tab-buttons" role="tablist">
        <button class="tab-button active" data-tab="teamSelectionTab" role="tab" aria-selected="true" aria-controls="teamSelectionTab">Team Selection</button>
        <button class="tab-button" data-tab="teeAssignmentTab" id="teeAssignmentTabButton" role="tab" aria-selected="false" aria-controls="teeAssignmentTab">Tee Assignment</button>
        <button id="helpButton" aria-label="Show tutorial">Help</button>
        <button id="saveButton" aria-label="Save data">Save</button>
        <button id="loadButton" aria-label="Load data">Load</button>
    </div>
    
    <div class="tab-content active" id="teamSelectionTab" role="tabpanel" aria-labelledby="teamSelectionTab">
        <div class="container">
            <div class="input-section">
                <h2>Add Players</h2>
                <div id="errorMessages" role="alert" aria-live="assertive"></div>
                
                <div class="form-group">
                    <label for="fileInput">Import Players from CSV (optional):</label>
                    <input type="file" id="fileInput" accept=".csv" class="file-input" aria-describedby="csvFormat">
                    <small id="csvFormat">CSV format: LastName,FirstName,Handicap (e.g., "Smith,John,10.5" or "Smith,John,+2.1")</small>
                </div>
                
                <div class="form-group">
                    <label for="playerName">Player Name:</label>
                    <input type="text" id="playerName" placeholder="Last Name, First Name" aria-describedby="nameValidation">
                    <div id="nameValidation" class="validation-feedback" aria-live="polite"></div>
                </div>
                
                <div class="form-group">
                    <label for="playerHandicap">Handicap:</label>
                    <input type="text" id="playerHandicap" placeholder="Enter handicap (e.g., 10.5 or +2.1)" aria-describedby="handicapValidation">
                    <div id="handicapValidation" class="validation-feedback" aria-live="polite"></div>
                </div>
                
                <button id="addPlayerBtn" aria-label="Add player to list">Add Player</button>
                <button id="resetBtn" aria-label="Reset all data">Reset All</button>
                
                <div class="player-list" id="playerList" aria-label="Player list" tabindex="0">
                    <!-- Player items will be added here -->
                </div>
                
                <p class="stats" id="playerCount" aria-live="polite">Total players: 0</p>
            </div>
            
            <div class="groups-display">
                <h2>Players by Group</h2>
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="balanceTeamsToggle" aria-label="Balance teams by handicap">
                        <span class="slider"></span>
                    </label>
                    <span>Balance teams by handicap</span>
                    <div class="help-tooltip" aria-label="Help about team balancing" tabindex="0">
                        ?
                        <span class="help-text">When enabled, the system will attempt to create teams with similar total handicaps, ensuring more balanced competition.</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="maxHandicapDiff">Maximum Handicap Difference:</label>
                    <input type="number" id="maxHandicapDiff" value="5" min="0" max="20" step="0.5" aria-describedby="handicapDiffHelp">
                    <small id="handicapDiffHelp">Maximum allowed difference between team handicaps (set to 0 to disable).</small>
                </div>
                
                <button id="groupPlayersBtn" aria-label="Group players by handicap">Group Players</button>
                
                <div class="group-container">
                    <div class="group">
                        <h3>Group A</h3>
                        <div id="groupA" class="player-list" tabindex="0" aria-label="Group A players"></div>
                    </div>
                    
                    <div class="group">
                        <h3>Group B</h3>
                        <div id="groupB" class="player-list" tabindex="0" aria-label="Group B players"></div>
                    </div>
                </div>
                
                <div class="group-container">
                    <div class="group">
                        <h3>Group C</h3>
                        <div id="groupC" class="player-list" tabindex="0" aria-label="Group C players"></div>
                    </div>
                    
                    <div class="group">
                        <h3>Group D</h3>
                        <div id="groupD" class="player-list" tabindex="0" aria-label="Group D players"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="team-selection">
            <h2>Team Selection</h2>
            <p>Select teams with one player from each group.</p>
            
            <div class="selection-animation">
                <div class="selection-slot" id="slotA" tabindex="0" aria-label="Selection slot for Group A">A</div>
                <div class="selection-slot" id="slotB" tabindex="0" aria-label="Selection slot for Group B">B</div>
                <div class="selection-slot" id="slotC" tabindex="0" aria-label="Selection slot for Group C">C</div>
                <div class="selection-slot" id="slotD" tabindex="0" aria-label="Selection slot for Group D">D</div>
            </div>
            
            <button id="selectTeamBtn" disabled aria-label="Select next team">Select Next Team</button>
            <button id="selectAllBtn" disabled aria-label="Auto-select all teams">Auto-Select All Teams</button>
            <button id="draftStyleSelectBtn" disabled aria-label="Draft style team selection">Draft Style Pairing</button>
            
            <p class="stats" id="teamCount" aria-live="polite">Teams created: 0</p>
            
            <div class="party-buttons">
                <button id="showBracketBtn" class="show-bracket-btn" disabled>Show Tournament Bracket</button>
            </div>
        </div>
        
        <div class="teams-display">
            <h2>Teams</h2>
            <div class="teams-grid" id="teamsContainer" aria-label="Teams list" tabindex="0">
                <!-- Team cards will be added here -->
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="teeAssignmentTab" role="tabpanel" aria-labelledby="teeAssignmentTab">
        <h2>Tee Assignment</h2>
        <p>Assign teams to starting holes. Double-stacked holes are highlighted in green.</p>
        
        <div class="tee-time-settings">
            <h3>Tee Time Settings</h3>
            <div class="tee-time-row">
                <div class="tee-time-field">
                    <label for="startFormat">Start Format:</label>
                    <select id="startFormat" aria-describedby="startFormatHelp">
                        <option value="sequential">Sequential Start</option>
                        <option value="shotgun">Shotgun Start</option>
                    </select>
                    <div id="startFormatHelp" class="help-tooltip" aria-label="Help about start format" tabindex="0">
                        ?
                        <span class="help-text">Sequential Start: Teams start at intervals from the first hole. Shotgun Start: All teams start simultaneously at different holes.</span>
                    </div>
                </div>
                
                <div class="tee-time-field">
                    <label for="startTime">Start Time:</label>
                    <input type="time" id="startTime" value="08:00" aria-label="First tee time">
                </div>
                
                <div class="tee-time-field">
                    <label for="timeInterval">Time Interval (minutes):</label>
                    <input type="number" id="timeInterval" value="10" min="5" max="20" step="5" aria-label="Minutes between tee times">
                </div>
            </div>
        </div>
        
        <div class="course-layout">
            <h3>Course Layout</h3>
            <div id="courseLayout" aria-label="Course layout with 18 holes" tabindex="0">
                <!-- Hole boxes will be added here -->
            </div>
        </div>
        
        <div class="unassigned-teams" id="unassignedTeams">
            <h3>Unassigned Teams</h3>
            <div id="unassignedTeamsList" aria-label="Unassigned teams" tabindex="0">
                <!-- Unassigned teams will be listed here -->
            </div>
        </div>
        
        <div class="assign-buttons">
            <button id="autoAssignBtn" class="assign-button" aria-label="Auto-assign teams to holes">Auto-Assign Teams to Holes</button>
            <button id="randomAssignBtn" class="assign-button" aria-label="Randomly assign teams to holes">Randomize Tee Assignments</button>
            <button id="resetAssignmentBtn" class="assign-button" aria-label="Reset hole assignments">Reset Assignments</button>
        </div>
        
        <div class="tee-sheet-container" id="teeSheetContainer">
            <h3>Tee Sheet</h3>
            <table class="tee-sheet-table" id="teeSheetTable" aria-label="Tee sheet with team assignments">
                <thead>
                    <tr>
                        <th>Hole</th>
                        <th>Tee Time</th>
                        <th>Team</th>
                        <th>Player A</th>
                        <th>Player B</th>
                        <th>Player C</th>
                        <th>Player D</th>
                    </tr>
                </thead>
                <tbody id="teeSheetBody">
                    <!-- Tee sheet rows will be added here -->
                </tbody>
            </table>
            
            <button id="printTeeSheetBtn" class="print-button" aria-label="Print tee sheet">Print Tee Sheet</button>
        </div>
    </div>
    
    <!-- Tutorial Modal -->
    <div id="tutorialOverlay" class="tutorial-overlay" style="display: none;">
        <div class="tutorial-content" role="dialog" aria-labelledby="tutorialTitle" aria-describedby="tutorialDescription">
            <h2 id="tutorialTitle">Golf Team Selector Tutorial</h2>
            <p id="tutorialDescription">Follow these steps to create balanced teams and assign tee times.</p>
            
            <div class="tutorial-steps">
                <!-- Step content will be dynamically inserted here -->
            </div>
            
            <div class="tutorial-nav">
                <button id="tutorialPrevBtn" disabled>Previous</button>
                <span id="tutorialProgress">Step 1 of 5</span>
                <button id="tutorialNextBtn">Next</button>
            </div>
            
            <button class="tutorial-close" aria-label="Close tutorial">&times;</button>
        </div>
    </div>
    
    <script>
        /**
         * Golf Team Selector & Tee Assignment Application
         * 
         * A modular application for organizing golf teams and creating tee time assignments
         */
        
        // Use an IIFE to avoid polluting the global scope
        (function() {
            'use strict';
            
            // Main application namespace
            const GolfApp = {};
            
            /**
             * Data Model Module
             * Handles data structures and validation
             */
            GolfApp.DataModel = (function() {
                // Private data
                const _data = {
                    players: [],
                    groups: { A: [], B: [], C: [], D: [] },
                    teams: [],
                    holeAssignments: {},
                    settings: {
                        balanceTeams: false,
                        maxHandicapDiff: 5,
                        startFormat: 'sequential',
                        startTime: '08:00',
                        timeInterval: 10
                    }
                };
                
                // Double-stacked holes configuration
                const doubleStackedHoles = [3, 4, 6, 7, 8, 10, 12, 13, 16, 18];
                
                // Player validation
                function validatePlayerName(name) {
                    if (!name || name.trim() === '') {
                        return { valid: false, message: 'Name is required' };
                    }
                    
                    // Check for comma to indicate last name, first name format
                    if (!name.includes(',')) {
                        return { valid: false, message: 'Use format: Last Name, First Name' };
                    }
                    
                    return { valid: true };
                }
                
                function validateHandicap(handicap) {
                    if (!handicap || handicap.trim() === '') {
                        return { valid: false, message: 'Handicap is required' };
                    }
                    
                    const isPlus = handicap.includes('+');
                    const handicapValue = parseFloat(isPlus ? handicap.replace('+', '') : handicap);
                    
                    if (isNaN(handicapValue)) {
                        return { valid: false, message: 'Handicap must be a number' };
                    }
                    
                    if (handicapValue < 0 && !isPlus) {
                        return { valid: false, message: 'Use +value format for plus handicaps' };
                    }
                    
                    if (handicapValue > 54) {
                        return { valid: false, message: 'Handicap cannot exceed 54.0' };
                    }
                    
                    return { valid: true, value: handicapValue, isPlus: isPlus };
                }
                
                // Calculate team handicap
                function calculateTeamHandicap(team) {
                    let total = 0;
                    team.members.forEach(player => {
                        // Plus handicaps are negative values for calculation
                        const value = player.isPlus ? -player.handicap : player.handicap;
                        total += value;
                    });
                    return total;
                }
                
                // Public API
                return {
                    // Constant values
                    getDoubleStackedHoles: () => doubleStackedHoles,
                    
                    // Data accessors
                    getPlayers: () => _data.players,
                    getGroups: () => _data.groups,
                    getTeams: () => _data.teams,
                    getHoleAssignments: () => _data.holeAssignments,
                    getSettings: () => _data.settings,
                    
                    // Data mutators
                    setPlayers: (players) => { _data.players = players; },
                    setGroups: (groups) => { _data.groups = groups; },
                    setTeams: (teams) => { _data.teams = teams; },
                    setHoleAssignments: (assignments) => { _data.holeAssignments = assignments; },
                    updateSetting: (key, value) => { _data.settings[key] = value; },
                    
                    // Reset all data
                    resetAll: () => {
                        _data.players = [];
                        _data.groups = { A: [], B: [], C: [], D: [] };
                        _data.teams = [];
                        _data.holeAssignments = {};
                        // Don't reset settings
                    },
                    
                    // Add a player to the players array
                    addPlayer: (nameInput, handicapInput) => {
                        const nameValidation = validatePlayerName(nameInput);
                        const handicapValidation = validateHandicap(handicapInput);
                        
                        if (!nameValidation.valid || !handicapValidation.valid) {
                            return {
                                valid: false,
                                errors: {
                                    name: nameValidation.valid ? null : nameValidation.message,
                                    handicap: handicapValidation.valid ? null : handicapValidation.message
                                }
                            };
                        }
                        
                        const player = {
                            name: nameInput.trim(),
                            handicap: handicapValidation.value,
                            isPlus: handicapValidation.isPlus,
                            displayHandicap: handicapValidation.isPlus ? 
                                `+${handicapValidation.value}` : 
                                handicapValidation.value.toString()
                        };
                        
                        _data.players.push(player);
                        return { valid: true, player };
                    },
                    
                    // Remove a player from the players array
                    removePlayer: (index) => {
                        if (index >= 0 && index < _data.players.length) {
                            _data.players.splice(index, 1);
                            return true;
                        }
                        return false;
                    },
                    
                    // Group players into A, B, C, D based on handicaps
                    groupPlayers: () => {
                        if (_data.players.length < 4) {
                            return { success: false, message: "Please add at least 4 players to form groups." };
                        }
                        
                        // Reset groups
                        _data.groups = { A: [], B: [], C: [], D: [] };
                        
                        // Sort players by handicap (plus handicaps first, then regular handicaps)
                        const sortedPlayers = [..._data.players].sort((a, b) => {
                            if (a.isPlus && !b.isPlus) return -1;
                            if (!a.isPlus && b.isPlus) return 1;
                            
                            if (a.isPlus && b.isPlus) {
                                return b.handicap - a.handicap; // Higher plus is better
                            } else {
                                return a.handicap - b.handicap; // Lower regular is better
                            }
                        });
                        
                        // Divide players into quartiles
                        const quarterSize = Math.ceil(sortedPlayers.length / 4);
                        _data.groups.A = sortedPlayers.slice(0, quarterSize);
                        _data.groups.B = sortedPlayers.slice(quarterSize, quarterSize * 2);
                        _data.groups.C = sortedPlayers.slice(quarterSize * 2, quarterSize * 3);
                        _data.groups.D = sortedPlayers.slice(quarterSize * 3);
                        
                        return { success: true };
                    },
                    
                    // Select a team based on the balancing setting
                    selectTeam: () => {
                        const groups = _data.groups;
                        
                        if (groups.A.length === 0 || groups.B.length === 0 || 
                            groups.C.length === 0 || groups.D.length === 0) {
                            return { success: false, message: "Not enough players left to form a full team." };
                        }
                        
                        let playerA, playerB, playerC, playerD;
                        
                        if (_data.settings.balanceTeams && _data.teams.length > 0) {
                            // If balancing teams, select players to create a team with handicap close to average
                            // First, calculate average team handicap
                            let totalHandicap = 0;
                            _data.teams.forEach(team => {
                                totalHandicap += calculateTeamHandicap(team);
                            });
                            const avgHandicap = totalHandicap / _data.teams.length;
                            
                            // Try different combinations to find balanced team
                            let bestTeam = null;
                            let bestDifference = Infinity;
                            
                            // Try a limited number of combinations to avoid performance issues
                            const maxAttempts = 50;
                            
                            // If max handicap difference is set, use it to filter acceptable teams
                            const maxDiff = parseFloat(_data.settings.maxHandicapDiff) || 0;
                            
                            for (let i = 0; i < maxAttempts; i++) {
                                const testPlayerA = groups.A[Math.floor(Math.random() * groups.A.length)];
                                const testPlayerB = groups.B[Math.floor(Math.random() * groups.B.length)];
                                const testPlayerC = groups.C[Math.floor(Math.random() * groups.C.length)];
                                const testPlayerD = groups.D[Math.floor(Math.random() * groups.D.length)];
                                
                                const testTeam = {
                                    members: [testPlayerA, testPlayerB, testPlayerC, testPlayerD]
                                };
                                
                                const teamHandicap = calculateTeamHandicap(testTeam);
                                const difference = Math.abs(teamHandicap - avgHandicap);
                                
                                // If max difference is set and this team is within the limit, or if it's the best so far
                                if ((maxDiff > 0 && difference <= maxDiff) || difference < bestDifference) {
                                    bestDifference = difference;
                                    bestTeam = [testPlayerA, testPlayerB, testPlayerC, testPlayerD];
                                    
                                    // If we found a team within the acceptable range, we can stop early
                                    if (maxDiff > 0 && difference <= maxDiff) {
                                        break;
                                    }
                                }
                            }
                            
                            if (bestTeam) {
                                playerA = bestTeam[0];
                                playerB = bestTeam[1];
                                playerC = bestTeam[2];
                                playerD = bestTeam[3];
                            }
                        } else {
                            // Random selection
                            playerA = groups.A[Math.floor(Math.random() * groups.A.length)];
                            playerB = groups.B[Math.floor(Math.random() * groups.B.length)];
                            playerC = groups.C[Math.floor(Math.random() * groups.C.length)];
                            playerD = groups.D[Math.floor(Math.random() * groups.D.length)];
                        }
                        
                        // Remove selected players from groups
                        groups.A.splice(groups.A.indexOf(playerA), 1);
                        groups.B.splice(groups.B.indexOf(playerB), 1);
                        groups.C.splice(groups.C.indexOf(playerC), 1);
                        groups.D.splice(groups.D.indexOf(playerD), 1);
                        
                        const team = {
                            id: _data.teams.length + 1,
                            members: [playerA, playerB, playerC, playerD]
                        };
                        
                        // Calculate team handicap
                        team.totalHandicap = calculateTeamHandicap(team);
                        
                        // Add team to teams array
                        _data.teams.push(team);
                        
                        return { success: true, team };
                    },
                    
                    // Check if teams can be formed with current groups
                    canFormTeam: () => {
                        const groups = _data.groups;
                        return groups.A.length > 0 && groups.B.length > 0 && 
                               groups.C.length > 0 && groups.D.length > 0;
                    },
                    
                    // Find team by ID
                    findTeamById: (teamId) => {
                        return _data.teams.find(team => team.id === teamId);
                    },
                    
                    // Assign team to hole
                    assignTeamToHole: (teamId, hole) => {
                        if (!_data.holeAssignments[hole]) {
                            _data.holeAssignments[hole] = [];
                        }
                        
                        // Check if hole can accept more teams
                        const isDoubleStacked = doubleStackedHoles.includes(Number(hole));
                        const maxTeams = isDoubleStacked ? 2 : 1;
                        
                        if (_data.holeAssignments[hole].length >= maxTeams) {
                            return { success: false, message: `Hole ${hole} already has the maximum number of teams.` };
                        }
                        
                        // Remove team from any other hole it might be assigned to
                        for (const h in _data.holeAssignments) {
                            const index = _data.holeAssignments[h].indexOf(teamId);
                            if (index !== -1) {
                                _data.holeAssignments[h].splice(index, 1);
                            }
                        }
                        
                        // Assign team to this hole
                        _data.holeAssignments[hole].push(teamId);
                        
                        return { success: true };
                    },
                    
                    // Remove team from hole
                    removeTeamFromHole: (teamId, hole) => {
                        if (!_data.holeAssignments[hole]) {
                            return { success: false, message: "Hole does not exist." };
                        }
                        
                        const index = _data.holeAssignments[hole].indexOf(teamId);
                        if (index !== -1) {
                            _data.holeAssignments[hole].splice(index, 1);
                            return { success: true };
                        }
                        
                        return { success: false, message: "Team not assigned to this hole." };
                    },
                    
                    // Get all assigned team IDs
                    getAssignedTeamIds: () => {
                        const assignedTeams = [];
                        for (const hole in _data.holeAssignments) {
                            assignedTeams.push(..._data.holeAssignments[hole]);
                        }
                        return assignedTeams;
                    },
                    
                    // Auto-assign teams to holes
                    autoAssignTeams: () => {
                        // Reset existing assignments
                        for (let i = 1; i <= 18; i++) {
                            _data.holeAssignments[i] = [];
                        }
                        
                        // Get all teams that need to be assigned
                        const teamsToAssign = [..._data.teams.map(team => team.id)];
                        
                        // First, assign teams to double-stacked holes
                        for (const hole of doubleStackedHoles) {
                            for (let i = 0; i < 2; i++) {
                                if (teamsToAssign.length > 0) {
                                    const teamId = teamsToAssign.shift();
                                    _data.holeAssignments[hole].push(teamId);
                                }
                            }
                        }
                        
                        // Then, assign remaining teams to single-stacked holes
                        for (let hole = 1; hole <= 18; hole++) {
                            if (!doubleStackedHoles.includes(hole)) {
                                if (teamsToAssign.length > 0) {
                                    const teamId = teamsToAssign.shift();
                                    _data.holeAssignments[hole].push(teamId);
                                }
                            }
                        }
                        
                        return { success: true };
                    },
                    
                    // Randomly assign teams to holes
                    randomizeTeamAssignments: () => {
                        // Reset existing assignments
                        for (let i = 1; i <= 18; i++) {
                            _data.holeAssignments[i] = [];
                        }
                        
                        // Get all teams that need to be assigned
                        const teamsToAssign = [..._data.teams.map(team => team.id)];
                        
                        // Shuffle the teams
                        for (let i = teamsToAssign.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [teamsToAssign[i], teamsToAssign[j]] = [teamsToAssign[j], teamsToAssign[i]];
                        }
                        
                        // Create an array of available holes with their capacity
                        const availableHoles = [];
                        
                        // Add double-stacked holes with capacity 2
                        doubleStackedHoles.forEach(hole => {
                            availableHoles.push({ hole, capacity: 2 });
                        });
                        
                        // Add single-stacked holes with capacity 1
                        for (let hole = 1; hole <= 18; hole++) {
                            if (!doubleStackedHoles.includes(hole)) {
                                availableHoles.push({ hole, capacity: 1 });
                            }
                        }
                        
                        // Shuffle the holes
                        for (let i = availableHoles.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [availableHoles[i], availableHoles[j]] = [availableHoles[j], availableHoles[i]];
                        }
                        
                        // Assign teams to holes
                        let holeIndex = 0;
                        
                        while (teamsToAssign.length > 0 && holeIndex < availableHoles.length) {
                            const hole = availableHoles[holeIndex].hole;
                            
                            if (!_data.holeAssignments[hole]) {
                                _data.holeAssignments[hole] = [];
                            }
                            
                            if (_data.holeAssignments[hole].length < availableHoles[holeIndex].capacity) {
                                const teamId = teamsToAssign.shift();
                                _data.holeAssignments[hole].push(teamId);
                            } else {
                                holeIndex++;
                            }
                        }
                        
                        return { success: true };
                    },
                    
                    // Process CSV data
                    processCSV: (csv) => {
                        const lines = csv.split(/\r\n|\n/);
                        const importedPlayers = [];
                        const errors = [];
                        
                        for (let i = 0; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const parts = lines[i].split(',');
                            if (parts.length < 3) {
                                errors.push(`Line ${i+1} doesn't have enough data. Format should be LastName,FirstName,Handicap`);
                                continue;
                            }
                            
                            const lastName = parts[0].trim();
                            const firstName = parts[1].trim();
                            const handicapInput = parts[2].trim();
                            
                            const handicapValidation = validateHandicap(handicapInput);
                            
                            if (!handicapValidation.valid) {
                                errors.push(`Invalid handicap format in line ${i+1}: ${handicapValidation.message}`);
                                continue;
                            }
                            
                            const player = {
                                name: `${lastName}, ${firstName}`,
                                handicap: handicapValidation.value,
                                isPlus: handicapValidation.isPlus,
                                displayHandicap: handicapValidation.isPlus ? 
                                    `+${handicapValidation.value}` : 
                                    handicapValidation.value.toString()
                            };
                            
                            importedPlayers.push(player);
                        }
                        
                        return { players: importedPlayers, errors };
                    },
                    
                    // Save data to localStorage
                    saveToLocalStorage: () => {
                        try {
                            const dataToSave = {
                                players: _data.players,
                                groups: _data.groups,
                                teams: _data.teams,
                                holeAssignments: _data.holeAssignments,
                                settings: _data.settings
                            };
                            localStorage.setItem('golfApp', JSON.stringify(dataToSave));
                            return { success: true };
                        } catch (error) {
                            return { success: false, message: `Failed to save data: ${error.message}` };
                        }
                    },
                    
                    // Load data from localStorage
                    loadFromLocalStorage: () => {
                        try {
                            const savedData = localStorage.getItem('golfApp');
                            if (!savedData) {
                                return { success: false, message: 'No saved data found' };
                            }
                            
                            const parsedData = JSON.parse(savedData);
                            _data.players = parsedData.players || [];
                            _data.groups = parsedData.groups || { A: [], B: [], C: [], D: [] };
                            _data.teams = parsedData.teams || [];
                            _data.holeAssignments = parsedData.holeAssignments || {};
                            
                            // Only load settings if they exist
                            if (parsedData.settings) {
                                _data.settings = parsedData.settings;
                            }
                            
                            return { success: true };
                        } catch (error) {
                            return { success: false, message: `Failed to load data: ${error.message}` };
                        }
                    },
                    
                    // Draft Style Team Selection (Round by Round D->C->B->A with Balancing)
                    draftStyleTeamSelection: () => {
                        const groups = _data.groups;
                        const settings = _data.settings;
                        
                        // Determine the number of teams that can be formed
                        const numTeams = Math.min(groups.A.length, groups.B.length, groups.C.length, groups.D.length);
                        
                        if (numTeams === 0) {
                            return { success: false, message: "Not enough players in all groups to form any teams." };
                        }
                        
                        // Create copies of groups to track available players during the draft
                        const availableGroups = {
                            A: [...groups.A],
                            B: [...groups.B],
                            C: [...groups.C],
                            D: [...groups.D]
                        };
                        
                        const draftedTeamsData = Array.from({ length: numTeams }, () => ({ members: [], partialHandicap: 0 }));
                        const finalTeams = [];
                        
                        // --- Balancing Setup (if enabled) ---
                        let targetTeamHandicap = 0;
                        let avgPlayerHandicap = 0;
                        if (_data.players.length > 0) {
                            let totalPlayerHandicap = 0;
                            _data.players.forEach(p => {
                                totalPlayerHandicap += p.isPlus ? -p.handicap : p.handicap;
                            });
                            avgPlayerHandicap = totalPlayerHandicap / _data.players.length;
                            targetTeamHandicap = avgPlayerHandicap * 4; // Initial target based on overall average
                        }
                        
                        // Adjust target based on existing teams' average if applicable and balancing is on
                        if (settings.balanceTeams && _data.teams.length > 0) {
                            let existingTeamTotalHandicap = 0;
                            _data.teams.forEach(team => { existingTeamTotalHandicap += calculateTeamHandicap(team); });
                            const avgExistingTeamHandicap = existingTeamTotalHandicap / _data.teams.length;
                            targetTeamHandicap = avgExistingTeamHandicap; // Prioritize matching existing teams
                        }
                        
                        // Helper to get player's numeric handicap value
                        const getNumericHandicap = (player) => player.isPlus ? -player.handicap : player.handicap;
                        
                        // --- Draft Rounds ---
                        const draftOrder = ['D', 'C', 'B', 'A'];
                        
                        for (const groupLetter of draftOrder) {
                            const currentAvailableGroup = availableGroups[groupLetter];
                            
                            for (let i = 0; i < numTeams; i++) {
                                if (currentAvailableGroup.length === 0) {
                                    console.error(`Ran out of players in Group ${groupLetter} unexpectedly.`);
                                    return { success: false, message: `Error during draft: Not enough players in Group ${groupLetter}.` };
                                }
                                
                                let chosenPlayer;
                                let chosenPlayerIndex;
                                
                                if (settings.balanceTeams && groupLetter !== 'D') {
                                    // Balancing Logic (for C, B, A rounds)
                                    const currentPartialHandicap = draftedTeamsData[i].partialHandicap;
                                    
                                    let bestPlayer = null;
                                    let bestPlayerIdx = -1;
                                    let minDifference = Infinity;
                                    
                                    // Find player that gets team 'i' closest to the targetTeamHandicap
                                    for (let j = 0; j < currentAvailableGroup.length; j++) {
                                        const potentialPlayer = currentAvailableGroup[j];
                                        const potentialPlayerHandicap = getNumericHandicap(potentialPlayer);
                                        // Predict final handicap if this player is chosen (using avg for remaining picks)
                                        const remainingRounds = draftOrder.length - (draftOrder.indexOf(groupLetter) + 1);
                                        const predictedFinalHandicap = currentPartialHandicap + potentialPlayerHandicap + (remainingRounds * avgPlayerHandicap);
                                        
                                        const difference = Math.abs(predictedFinalHandicap - targetTeamHandicap);
                                        
                                        if (difference < minDifference) {
                                            minDifference = difference;
                                            bestPlayer = potentialPlayer;
                                            bestPlayerIdx = j;
                                        }
                                    }
                                    
                                    if (bestPlayerIdx === -1) { // Fallback if something went wrong
                                        bestPlayerIdx = Math.floor(Math.random() * currentAvailableGroup.length);
                                        bestPlayer = currentAvailableGroup[bestPlayerIdx];
                                    }
                                    chosenPlayer = bestPlayer;
                                    chosenPlayerIndex = bestPlayerIdx;
                                    
                                } else {
                                    // Random Selection (for D round or if balancing is off)
                                    chosenPlayerIndex = Math.floor(Math.random() * currentAvailableGroup.length);
                                    chosenPlayer = currentAvailableGroup[chosenPlayerIndex];
                                }
                                
                                // Assign player and update partial handicap
                                draftedTeamsData[i].members.push(chosenPlayer);
                                draftedTeamsData[i].partialHandicap += getNumericHandicap(chosenPlayer);
                                
                                // Remove player from available list for this round
                                currentAvailableGroup.splice(chosenPlayerIndex, 1);
                            }
                        }
                        
                        // --- Finalize Teams ---
                        draftedTeamsData.forEach((draftedTeamData, index) => {
                            // Reorder members A, B, C, D for consistency
                            const finalMembers = [
                                draftedTeamData.members.find(p => _data.groups.A.some(orig => orig === p)),
                                draftedTeamData.members.find(p => _data.groups.B.some(orig => orig === p)),
                                draftedTeamData.members.find(p => _data.groups.C.some(orig => orig === p)),
                                draftedTeamData.members.find(p => _data.groups.D.some(orig => orig === p))
                            ].filter(p => p !== undefined); // Filter out undefined in case of error
                            
                            if (finalMembers.length !== 4) {
                                console.error("Error assembling final team members for team index:", index, draftedTeamData);
                                // Skip this team or handle error appropriately
                                return; 
                            }

                            const newTeam = {
                                id: _data.teams.length + finalTeams.length + 1, // Use finalTeams.length for correct ID increment
                                members: finalMembers
                            };
                            newTeam.totalHandicap = calculateTeamHandicap(newTeam);
                            finalTeams.push(newTeam);
                            
                            // Remove drafted players from the main data groups AFTER all teams are drafted
                            // This is done outside this loop to avoid modifying groups while iterating
                        });

                        // Now remove all drafted players from the main _data.groups
                        finalTeams.forEach(team => {
                            team.members.forEach(player => {
                                const groupKey = ['A', 'B', 'C', 'D'].find(key => _data.groups[key].some(orig => orig === player));
                                if (groupKey) {
                                    const playerIndex = _data.groups[groupKey].indexOf(player);
                                    if (playerIndex > -1) {
                                        _data.groups[groupKey].splice(playerIndex, 1);
                                    }
                                }
                            });
                        });
                        
                        // Add all newly created teams to the main teams list
                        _data.teams.push(...finalTeams);
                        
                        return { success: true, teams: finalTeams, numTeamsCreated: finalTeams.length };
                    },
                    
                    // Calculate team handicap
                    calculateTeamHandicap: calculateTeamHandicap
                };
            })();
            
            /**
             * UI Controller Module
             * Manages the user interface and DOM interactions
             */
            GolfApp.UIController = (function() {
                // Element references
                const DOMElements = {
                    // Tab navigation
                    tabButtons: document.querySelectorAll('.tab-button'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    teeAssignmentTabButton: document.getElementById('teeAssignmentTabButton'),
                    
                    // Player input
                    playerNameInput: document.getElementById('playerName'),
                    playerHandicapInput: document.getElementById('playerHandicap'),
                    addPlayerBtn: document.getElementById('addPlayerBtn'),
                    resetBtn: document.getElementById('resetBtn'),
                    playerList: document.getElementById('playerList'),
                    playerCountElement: document.getElementById('playerCount'),
                    
                    // Form validation
                    nameValidation: document.getElementById('nameValidation'),
                    handicapValidation: document.getElementById('handicapValidation'),
                    
                    // Team balance toggle
                    balanceTeamsToggle: document.getElementById('balanceTeamsToggle'),
                    maxHandicapDiff: document.getElementById('maxHandicapDiff'),
                    
                    // Group elements
                    groupPlayersBtn: document.getElementById('groupPlayersBtn'),
                    groupA: document.getElementById('groupA'),
                    groupB: document.getElementById('groupB'),
                    groupC: document.getElementById('groupC'),
                    groupD: document.getElementById('groupD'),
                    
                    // Team selection
                    selectTeamBtn: document.getElementById('selectTeamBtn'),
                    selectAllBtn: document.getElementById('selectAllBtn'),
                    draftStyleSelectBtn: document.getElementById('draftStyleSelectBtn'), // Added Draft Style Button
                    showBracketBtn: document.getElementById('showBracketBtn'),
                    teamsContainer: document.getElementById('teamsContainer'),
                    teamCountElement: document.getElementById('teamCount'),
                    
                    // Selection animation slots
                    selectionSlots: {
                        A: document.getElementById('slotA'),
                        B: document.getElementById('slotB'),
                        C: document.getElementById('slotC'),
                        D: document.getElementById('slotD')
                    },
                    
                    // Tee assignment
                    startFormatSelect: document.getElementById('startFormat'),
                    startTimeInput: document.getElementById('startTime'),
                    timeIntervalInput: document.getElementById('timeInterval'),
                    courseLayout: document.getElementById('courseLayout'),
                    unassignedTeamsList: document.getElementById('unassignedTeamsList'),
                    autoAssignBtn: document.getElementById('autoAssignBtn'),
                    randomAssignBtn: document.getElementById('randomAssignBtn'),
                    resetAssignmentBtn: document.getElementById('resetAssignmentBtn'),
                    teeSheetBody: document.getElementById('teeSheetBody'),
                    printTeeSheetBtn: document.getElementById('printTeeSheetBtn'),
                    
                    // Error messages
                    errorMessages: document.getElementById('errorMessages'),
                    
                    // File input
                    fileInput: document.getElementById('fileInput'),
                    
                    // Help and data persistence
                    helpButton: document.getElementById('helpButton'),
                    saveButton: document.getElementById('saveButton'),
                    loadButton: document.getElementById('loadButton'),
                    
                    // Tutorial elements
                    tutorialOverlay: document.getElementById('tutorialOverlay'),
                    tutorialSteps: document.querySelector('.tutorial-steps'),
                    tutorialPrevBtn: document.getElementById('tutorialPrevBtn'),
                    tutorialNextBtn: document.getElementById('tutorialNextBtn'),
                    tutorialProgress: document.getElementById('tutorialProgress'),
                    tutorialCloseBtn: document.querySelector('.tutorial-close')
                };
                
                // State for UI
                const UIState = {
                    isGrouped: false,
                    selectedTeamId: null,
                    currentTutorialStep: 0
                };
                
                // Tutorial content
                const tutorialSteps = [
                    {
                        title: "Step 1: Adding Players",
                        content: `
                            <p>Start by adding players to your tournament. You can:</p>
                            <ul>
                                <li>Add players individually using the name and handicap fields</li>
                                <li>Import players from a CSV file</li>
                            </ul>
                            <p>Make sure to use the Last Name, First Name format and the correct handicap format (regular or + for plus handicaps).</p>
                        `
                    },
                    {
                        title: "Step 2: Grouping Players",
                        content: `
                            <p>Once you've added all your players, click "Group Players" to automatically divide them into 4 groups (A, B, C, D) based on handicap:</p>
                            <ul>
                                <li>Group A: Best handicaps (lowest or plus handicaps)</li>
                                <li>Group B: Second-best handicaps</li>
                                <li>Group C: Third-best handicaps</li>
                                <li>Group D: Highest handicaps</li>
                            </ul>
                            <p>Enable "Balance teams by handicap" if you want teams to have similar total handicaps.</p>
                        `
                    },
                    {
                        title: "Step 3: Creating Teams",
                        content: `
                            <p>After grouping, you can create teams in two ways:</p>
                            <ul>
                                <li>Click "Select Next Team" to form teams one at a time</li>
                                <li>Click "Auto-Select All Teams" to create all possible teams at once</li>
                            </ul>
                            <p>Each team will include one player from each group (A, B, C, D).</p>
                        `
                    },
                    {
                        title: "Step 4: Tee Assignments",
                        content: `
                            <p>Switch to the "Tee Assignment" tab to assign teams to starting holes:</p>
                            <ul>
                                <li>Configure start format (Sequential or Shotgun)</li>
                                <li>Set start time and intervals between groups</li>
                                <li>Click "Auto-Assign Teams to Holes" or "Randomize Tee Assignments"</li>
                                <li>Manually assign by selecting a team and clicking on a hole</li>
                            </ul>
                            <p>Green-highlighted holes can accommodate two teams (double-stacked).</p>
                        `
                    },
                    {
                        title: "Step 5: Final Steps",
                        content: `
                            <p>Review your tee sheet to ensure all teams are properly assigned:</p>
                            <ul>
                                <li>Check tee times and player assignments</li>
                                <li>Click "Print Tee Sheet" to get a printable version</li>
                                <li>Use "Save" to store your data for future sessions</li>
                                <li>Show Tournament Bracket for a visual of the competition</li>
                            </ul>
                            <p>You can click "Help" anytime to return to this tutorial.</p>
                        `
                    }
                ];
                
                // Form validation
                function validateNameInput() {
                    const nameInput = DOMElements.playerNameInput.value.trim();
                    const validation = GolfApp.DataModel.validatePlayerName(nameInput);
                    
                    if (!validation.valid) {
                        DOMElements.nameValidation.textContent = validation.message;
                        DOMElements.playerNameInput.classList.add('input-invalid');
                        return false;
                    } else {
                        DOMElements.nameValidation.textContent = '';
                        DOMElements.playerNameInput.classList.remove('input-invalid');
                        return true;
                    }
                }
                
                function validateHandicapInput() {
                    const handicapInput = DOMElements.playerHandicapInput.value.trim();
                    const validation = GolfApp.DataModel.validateHandicap(handicapInput);
                    
                    if (!validation.valid) {
                        DOMElements.handicapValidation.textContent = validation.message;
                        DOMElements.playerHandicapInput.classList.add('input-invalid');
                        return false;
                    } else {
                        DOMElements.handicapValidation.textContent = '';
                        DOMElements.playerHandicapInput.classList.remove('input-invalid');
                        return true;
                    }
                }
                
                // Display functions
                function displayPlayers() {
                    const players = GolfApp.DataModel.getPlayers();
                    DOMElements.playerList.innerHTML = '';
                    
                    players.forEach((player, index) => {
                        const playerItem = document.createElement('div');
                        playerItem.className = 'player-item';
                        playerItem.innerHTML = `
                            <div>${player.name}</div>
                            <div>
                                <span>${player.displayHandicap}</span>
                                <button class="remove-btn" data-index="${index}" aria-label="Remove ${player.name}">X</button>
                            </div>
                        `;
                        
                        DOMElements.playerList.appendChild(playerItem);
                    });
                    
                    // Add event listeners to remove buttons
                    document.querySelectorAll('.remove-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const index = parseInt(this.getAttribute('data-index'));
                            GolfApp.DataModel.removePlayer(index);
                            displayPlayers();
                            
                            // Reset groups if players are modified
                            if (UIState.isGrouped) {
                                resetGroups();
                            }
                        });
                    });
                    
                    updatePlayerCount();
                }
                
                function displayGroups() {
                    const groups = GolfApp.DataModel.getGroups();
                    
                    // Clear previous groups
                    DOMElements.groupA.innerHTML = '';
                    DOMElements.groupB.innerHTML = '';
                    DOMElements.groupC.innerHTML = '';
                    DOMElements.groupD.innerHTML = '';
                    
                    // Display Group A
                    groups.A.forEach(player => {
                        const playerItem = document.createElement('div');
                        playerItem.className = 'player-item';
                        playerItem.innerHTML = `
                            <div>${player.name}</div>
                            <div>${player.displayHandicap}</div>
                        `;
                        DOMElements.groupA.appendChild(playerItem);
                    });
                    
                    // Display Group B
                    groups.B.forEach(player => {
                        const playerItem = document.createElement('div');
                        playerItem.className = 'player-item';
                        playerItem.innerHTML = `
                            <div>${player.name}</div>
                            <div>${player.displayHandicap}</div>
                        `;
                        DOMElements.groupB.appendChild(playerItem);
                    });
                    
                    // Display Group C
                    groups.C.forEach(player => {
                        const playerItem = document.createElement('div');
                        playerItem.className = 'player-item';
                        playerItem.innerHTML = `
                            <div>${player.name}</div>
                            <div>${player.displayHandicap}</div>
                        `;
                        DOMElements.groupC.appendChild(playerItem);
                    });
                    
                    // Display Group D
                    groups.D.forEach(player => {
                        const playerItem = document.createElement('div');
                        playerItem.className = 'player-item';
                        playerItem.innerHTML = `
                            <div>${player.name}</div>
                            <div>${player.displayHandicap}</div>
                        `;
                        DOMElements.groupD.appendChild(playerItem);
                    });
                }
                
                function displayTeams() {
                    const teams = GolfApp.DataModel.getTeams();
                    DOMElements.teamsContainer.innerHTML = '';
                    
                    teams.forEach(team => {
                        const teamCard = document.createElement('div');
                        teamCard.className = 'team-card';
                        
                        // Calculate team total handicap for display
                        const teamHandicap = GolfApp.DataModel.calculateTeamHandicap(team);
                        const displayHandicap = teamHandicap.toFixed(1);
                        const displaySign = teamHandicap < 0 ? '+' : '';
                        
                        teamCard.innerHTML = `
                            <h3>Team ${team.id}</h3>
                            <div class="team-member">
                                <strong>A:</strong> ${team.members[0].name} (${team.members[0].displayHandicap})
                            </div>
                            <div class="team-member">
                                <strong>B:</strong> ${team.members[1].name} (${team.members[1].displayHandicap})
                            </div>
                            <div class="team-member">
                                <strong>C:</strong> ${team.members[2].name} (${team.members[2].displayHandicap})
                            </div>
                            <div class="team-member">
                                <strong>D:</strong> ${team.members[3].name} (${team.members[3].displayHandicap})
                            </div>
                            <div class="team-stats">
                                <strong>Team Handicap:</strong> ${displaySign}${Math.abs(displayHandicap)}
                            </div>
                        `;
                        
                        if (team.id === teams.length) {
                            teamCard.classList.add('highlight');
                        }
                        
                        DOMElements.teamsContainer.appendChild(teamCard);
                    });
                    
                    // Scroll to the bottom to show the newest team
                    DOMElements.teamsContainer.scrollTop = DOMElements.teamsContainer.scrollHeight;
                    
                    // Enable the show bracket button if we have at least 2 teams
                    DOMElements.showBracketBtn.disabled = teams.length < 2;
                    
                    updateTeamCount();
                }
                
                function createCourseLayout() {
                    const doubleStackedHoles = GolfApp.DataModel.getDoubleStackedHoles();
                    DOMElements.courseLayout.innerHTML = '';
                    
                    // Create a hole box for each hole
                    for (let i = 1; i <= 18; i++) {
                        const holeBox = document.createElement('div');
                        holeBox.className = 'hole-box';
                        
                        // Add double-stacked class if applicable
                        if (doubleStackedHoles.includes(i)) {
                            holeBox.classList.add('double-stacked');
                        }
                        
                        holeBox.innerHTML = `
                            <div class="hole-number">${i}</div>
                            <div class="hole-teams" id="hole-${i}-teams"></div>
                        `;
                        
                        DOMElements.courseLayout.appendChild(holeBox);
                    }
                    
                    updateHoleDisplays();
                }
                
                function updateHoleDisplays() {
                    const holeAssignments = GolfApp.DataModel.getHoleAssignments();
                    const doubleStackedHoles = GolfApp.DataModel.getDoubleStackedHoles();
                    
                    // Clear and update each hole's team display
                    for (let i = 1; i <= 18; i++) {
                        const holeTeamsElement = document.getElementById(`hole-${i}-teams`);
                        if (!holeTeamsElement) continue;
                        
                        holeTeamsElement.innerHTML = '';
                        
                        // Add teams assigned to this hole
                        if (holeAssignments[i]) {
                            holeAssignments[i].forEach(teamId => {
                                const team = GolfApp.DataModel.findTeamById(teamId);
                                if (team) {
                                    const teamElement = document.createElement('div');
                                    teamElement.className = 'hole-team';
                                    teamElement.textContent = `Team ${team.id}`;
                                    teamElement.setAttribute('data-team-id', team.id);
                                    teamElement.setAttribute('data-hole', i);
                                    
                                    // Add click listener to remove team from hole
                                    teamElement.addEventListener('click', function() {
                                        const teamId = parseInt(this.getAttribute('data-team-id'));
                                        const hole = parseInt(this.getAttribute('data-hole'));
                                        
                                        // Remove the team from this hole
                                        GolfApp.DataModel.removeTeamFromHole(teamId, hole);
                                        updateHoleDisplays();
                                        displayUnassignedTeams();
                                        updateTeeSheet();
                                    });
                                    
                                    holeTeamsElement.appendChild(teamElement);
                                }
                            });
                        }
                        
                        // Add a placeholder if hole can accept more teams and is not full
                        const isDoubleStacked = doubleStackedHoles.includes(i);
                        const maxTeams = isDoubleStacked ? 2 : 1;
                        
                        if (!holeAssignments[i] || holeAssignments[i].length < maxTeams) {
                            const placeholderElement = document.createElement('div');
                            placeholderElement.className = 'hole-team';
                            placeholderElement.textContent = '(Empty)';
                            placeholderElement.style.color = '#999';
                            placeholderElement.style.fontStyle = 'italic';
                            placeholderElement.setAttribute('data-hole', i);
                            
                            // Add click listener to assign selected team to this hole
                            placeholderElement.addEventListener('click', function() {
                                const hole = parseInt(this.getAttribute('data-hole'));
                                
                                if (UIState.selectedTeamId !== null) {
                                    GolfApp.DataModel.assignTeamToHole(UIState.selectedTeamId, hole);
                                    UIState.selectedTeamId = null;
                                    updateHoleDisplays();
                                    displayUnassignedTeams();
                                    updateTeeSheet();
                                } else {
                                    showError("Please select a team to assign first.");
                                }
                            });
                            
                            holeTeamsElement.appendChild(placeholderElement);
                        }
                    }
                }
                
                function displayUnassignedTeams() {
                    const teams = GolfApp.DataModel.getTeams();
                    const assignedTeams = GolfApp.DataModel.getAssignedTeamIds();
                    
                    DOMElements.unassignedTeamsList.innerHTML = '';
                    
                    // Display teams that are not assigned to any hole
                    teams.forEach(team => {
                        if (!assignedTeams.includes(team.id)) {
                            const teamElement = document.createElement('div');
                            teamElement.className = 'unassigned-team';
                            if (UIState.selectedTeamId === team.id) {
                                teamElement.classList.add('selected');
                            }
                            teamElement.textContent = `Team ${team.id}`;
                            teamElement.setAttribute('data-team-id', team.id);
                            
                            // Add click listener to select this team
                            teamElement.addEventListener('click', function() {
                                const teamId = parseInt(this.getAttribute('data-team-id'));
                                selectTeamForAssignment(teamId);
                            });
                            
                            DOMElements.unassignedTeamsList.appendChild(teamElement);
                        }
                    });
                    
                    // Add message if no unassigned teams
                    if (DOMElements.unassignedTeamsList.children.length === 0) {
                        DOMElements.unassignedTeamsList.innerHTML = '<p>All teams have been assigned to holes.</p>';
                    }
                }
                
                function selectTeamForAssignment(teamId) {
                    // Deselect previously selected team
                    document.querySelectorAll('.unassigned-team').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    // Select new team
                    UIState.selectedTeamId = teamId;
                    const teamElement = document.querySelector(`.unassigned-team[data-team-id="${teamId}"]`);
                    if (teamElement) {
                        teamElement.classList.add('selected');
                    }
                }
                
                function updateTeeSheet() {
                    const teams = GolfApp.DataModel.getTeams();
                    const holeAssignments = GolfApp.DataModel.getHoleAssignments();
                    const settings = GolfApp.DataModel.getSettings();
                    
                    DOMElements.teeSheetBody.innerHTML = '';
                    
                    // Define a function to get all assigned teams with their hole and position
                    const getAssignedTeams = () => {
                        const assigned = [];
                        let sequentialPosition = 0;
                        
                        if (settings.startFormat === 'sequential') {
                            // For sequential start, order by hole 1 first, then others
                            if (holeAssignments[1]) {
                                holeAssignments[1].forEach(teamId => {
                                    assigned.push({
                                        teamId,
                                        hole: 1,
                                        position: sequentialPosition++
                                    });
                                });
                            }
                            
                            // Then add other holes
                            for (let hole = 2; hole <= 18; hole++) {
                                if (holeAssignments[hole]) {
                                    holeAssignments[hole].forEach(teamId => {
                                        assigned.push({
                                            teamId,
                                            hole,
                                            position: sequentialPosition++
                                        });
                                    });
                                }
                            }
                        } else {
                            // For shotgun start, use hole assignments directly
                            for (let hole = 1; hole <= 18; hole++) {
                                if (holeAssignments[hole]) {
                                    holeAssignments[hole].forEach((teamId, index) => {
                                        assigned.push({
                                            teamId,
                                            hole,
                                            position: index
                                        });
                                    });
                                }
                            }
                        }
                        
                        return assigned;
                    };
                    
                    const assignedTeams = getAssignedTeams();
                    
                    // Create rows for the tee sheet
                    assignedTeams.forEach(assignment => {
                        const team = teams.find(t => t.id === assignment.teamId);
                        if (!team) return;
                        
                        // Calculate tee time
                        let teeTime;
                        
                        if (settings.startFormat === 'shotgun') {
                            // In shotgun, all teams start at the same time
                            teeTime = settings.startTime;
                        } else {
                            // In sequential, calculate time based on position
                            const startTimeParts = settings.startTime.split(':');
                            const startTimeMinutes = 
                                parseInt(startTimeParts[0]) * 60 + 
                                parseInt(startTimeParts[1]);
                            
                            const additionalMinutes = assignment.position * parseInt(settings.timeInterval);
                            const totalMinutes = startTimeMinutes + additionalMinutes;
                            
                            const hours = Math.floor(totalMinutes / 60);
                            const minutes = totalMinutes % 60;
                            
                            teeTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${assignment.hole}</td>
                            <td>${teeTime}</td>
                            <td>Team ${team.id}</td>
                            <td>${team.members[0].name} (${team.members[0].displayHandicap})</td>
                            <td>${team.members[1].name} (${team.members[1].displayHandicap})</td>
                            <td>${team.members[2].name} (${team.members[2].displayHandicap})</td>
                            <td>${team.members[3].name} (${team.members[3].displayHandicap})</td>
                        `;
                        
                        DOMElements.teeSheetBody.appendChild(row);
                    });
                    
                    // Add rows for unassigned holes if needed
                    if (assignedTeams.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="7">No teams assigned yet</td>
                        `;
                        DOMElements.teeSheetBody.appendChild(row);
                    }
                }
                
                // UI update helpers
                function updatePlayerCount() {
                    const players = GolfApp.DataModel.getPlayers();
                    DOMElements.playerCountElement.textContent = `Total players: ${players.length}`;
                }
                
                function updateTeamCount() {
                    const teams = GolfApp.DataModel.getTeams();
                    DOMElements.teamCountElement.textContent = `Teams created: ${teams.length}`;
                }
                
                function showError(message) {
                    DOMElements.errorMessages.textContent = message;
                    // Clear error after 5 seconds
                    setTimeout(() => {
                        DOMElements.errorMessages.textContent = '';
                    }, 5000);
                }
                
                function clearError() {
                    DOMElements.errorMessages.textContent = '';
                }
                
                function resetGroups() {
                    UIState.isGrouped = false;
                    DOMElements.selectTeamBtn.disabled = true;
                    DOMElements.selectAllBtn.disabled = true;
                    DOMElements.draftStyleSelectBtn.disabled = true; // Disable draft button on reset
                    DOMElements.showBracketBtn.disabled = true;
                    
                    // Reset the groups in the data model
                    GolfApp.DataModel.setGroups({ A: [], B: [], C: [], D: [] });
                    
                    // Clear the group displays
                    DOMElements.groupA.innerHTML = '';
                    DOMElements.groupB.innerHTML = '';
                    DOMElements.groupC.innerHTML = '';
                    DOMElements.groupD.innerHTML = '';
                    
                    // Clear teams
                    GolfApp.DataModel.setTeams([]);
                    DOMElements.teamsContainer.innerHTML = '';
                    updateTeamCount();
                    
                    // Reset hole assignments
                    GolfApp.DataModel.setHoleAssignments({});
                    DOMElements.teeAssignmentTabButton.disabled = true;
                }
                
                // Pairing Party Enhancements
                
                // Enhanced team selection with full-screen animation
                async function enhancedTeamSelection() {
                    // Create fullscreen overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'selection-fullscreen';
                    
                    const title = document.createElement('h2');
                    title.textContent = `Team ${GolfApp.DataModel.getTeams().length + 1} Selection`;
                    
                    const drumDiv = document.createElement('div');
                    drumDiv.className = 'selection-drum';
                    
                    // Create large selection slots
                    const groups = ['A', 'B', 'C', 'D']; // Original order for slot creation
                    const slots = {};
                    
                    groups.forEach(group => {
                        const slot = document.createElement('div');
                        slot.className = 'selection-slot-large';
                        slot.textContent = group;
                        slot.id = `large-slot-${group}`;
                        drumDiv.appendChild(slot);
                        slots[group] = slot;
                    });
                    
                    // Create player display areas
                    const playerDisplays = document.createElement('div');
                    
                    groups.forEach(group => {
                        const playerDiv = document.createElement('div');
                        playerDiv.className = 'selected-player';
                        playerDiv.id = `selected-player-${group}`;
                        playerDisplays.appendChild(playerDiv);
                    });
                    
                    // Create team summary section
                    const teamSummary = document.createElement('div');
                    teamSummary.className = 'team-summary';
                    teamSummary.innerHTML = '<h3>Team Summary</h3><div id="team-handicap"></div>';
                    
                    // Add everything to overlay
                    overlay.appendChild(title);
                    overlay.appendChild(drumDiv);
                    overlay.appendChild(playerDisplays);
                    overlay.appendChild(teamSummary);
                    document.body.appendChild(overlay);
                    
                    // Try to play sound effect if available
                    try {
                        const drumrollSound = new Audio('https://soundbible.com/mp3/Snare_Drum_Roll-SoundBible.com-1017209109.mp3');
                        drumrollSound.play().catch(e => console.log('Audio playback prevented'));
                    } catch (e) {
                        console.log('Audio playback not supported');
                    }
                    
                    // Perform the selection
                    const result = GolfApp.DataModel.selectTeam();
                    if (!result.success) {
                        document.body.removeChild(overlay);
                        return { success: false, message: result.message };
                    }
                    
                    const team = result.team;
                    
                    // Animate each group selection in D -> C -> B -> A order
                    const revealOrder = ['D', 'C', 'B', 'A'];
                    // Map reveal order to team.members index (A=0, B=1, C=2, D=3)
                    const groupToIndex = { 'A': 0, 'B': 1, 'C': 2, 'D': 3 }; 

                    for (let i = 0; i < revealOrder.length; i++) {
                        const group = revealOrder[i]; // e.g., 'D' on first iteration
                        const slot = slots[group];
                        const playerDiv = document.getElementById(`selected-player-${group}`);
                        // Get the correct player directly from the team object using the index
                        const playerIndex = groupToIndex[group];
                        const player = team.members[playerIndex];
                        
                        // "Spin" animation
                        slot.textContent = '...';
                        slot.style.transform = 'scale(1.1)';
                        slot.style.boxShadow = '0 0 30px rgba(58, 128, 58, 0.8)';
                        
                        // Add random flicker effect during selection
                        const flickerInterval = setInterval(() => {
                            // Need access to the original group list before players were removed by selectTeam
                            const originalGroupData = GolfApp.DataModel.getGroups()[group] || []; // Use current if available
                            const allGroupPlayers = [...originalGroupData, player].filter(p => p); // Combine remaining + selected
                            
                            if (allGroupPlayers.length > 0) {
                                const randomIndex = Math.floor(Math.random() * allGroupPlayers.length);
                                const playerName = allGroupPlayers[randomIndex].name;
                                // Just show last name during flicker
                                slot.textContent = playerName.split(',')[0]; 
                            } else {
                                slot.textContent = '?'; // Fallback if group is empty
                            }
                        }, 100);
                        
                        // Wait for dramatic effect (adjust timing as needed)
                        await new Promise(resolve => setTimeout(resolve, 1000 + i * 300)); 
                        
                        // Clear flicker and show selected player
                        clearInterval(flickerInterval);
                        
                        if (!player) {
                            console.error(`Could not find player for group ${group} in team ${team.id}`);
                            slot.textContent = '?'; // Indicate error in slot
                            playerDiv.textContent = `${group}: Error`;
                            playerDiv.classList.add('reveal');
                            continue; // Skip if player not found for this group
                        }
                        
                        // Short name for the slot
                        const lastName = player.name.split(',')[0]; 
                        slot.textContent = lastName;
                        
                        // Full name and handicap for the player display
                        playerDiv.textContent = `${group}: ${player.name} (${player.displayHandicap})`;
                        playerDiv.classList.add('reveal');
                    }
                    
                    // Show team handicap
                    const teamHandicap = GolfApp.DataModel.calculateTeamHandicap(team);
                    const displaySign = teamHandicap < 0 ? '+' : '';
                    
                    document.getElementById('team-handicap').textContent = 
                        `Team Handicap: ${displaySign}${Math.abs(teamHandicap.toFixed(1))}`;
                    
                    // Allow time to view the team
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    // Remove overlay
                    document.body.removeChild(overlay);
                    
                    // Update displays
                    displayGroups();
                    displayTeams();
                    
                    return { success: true, team };
                }
                
                // Tournament bracket visualization
                function createTournamentBracket() {
                    const teams = GolfApp.DataModel.getTeams();
                    if (teams.length < 2) {
                        showError("Need at least 2 teams to show a tournament bracket.");
                        return;
                    }
                    
                    // Create bracket container
                    const bracketContainer = document.createElement('div');
                    bracketContainer.className = 'tournament-bracket-container';
                    
                    const bracketHTML = `
                        <h2>Tournament Preview</h2>
                        <div class="bracket">
                            ${generateBracketHTML(teams)}
                        </div>
                        <button id="closeBracketBtn" class="close-bracket-btn">Close</button>
                    `;
                    
                    bracketContainer.innerHTML = bracketHTML;
                    document.body.appendChild(bracketContainer);
                    
                    // Add close button event
                    document.getElementById('closeBracketBtn').addEventListener('click', () => {
                        document.body.removeChild(bracketContainer);
                    });
                }
                
                function generateBracketHTML(teams) {
                    // This function generates HTML for a tournament bracket based on the number of teams
                    // Calculate number of rounds needed for the bracket
                    const roundCount = Math.ceil(Math.log2(teams.length));
                    let html = '';
                    
                    for (let round = 0; round < roundCount; round++) {
                        html += `<div class="round round-${round + 1}">`;
                        html += `<h3>Round ${round + 1}</h3>`;
                        
                        const matchesInRound = Math.pow(2, roundCount - round - 1);
                        
                        for (let match = 0; match < matchesInRound; match++) {
                            if (round === 0 && match < teams.length / 2) {
                                // First round has actual teams
                                const team1Index = match * 2;
                                const team2Index = match * 2 + 1;
                                
                                html += `<div class="match">`;
                                html += `<div class="team">${team1Index < teams.length ? 'Team ' + teams[team1Index].id : 'TBD'}</div>`;
                                html += `<div class="team">${team2Index < teams.length ? 'Team ' + teams[team2Index].id : 'TBD'}</div>`;
                                html += `</div>`;
                            } else {
                                // Later rounds are placeholders
                                html += `<div class="match">`;
                                html += `<div class="team">Winner</div>`;
                                html += `<div class="team">Winner</div>`;
                                html += `</div>`;
                            }
                        }
                        
                        html += `</div>`;
                    }
                    
                    return html;
                }
                
                // Tutorial functions
                function showTutorial() {
                    // Set up the tutorial content
                    DOMElements.tutorialSteps.innerHTML = '';
                    tutorialSteps.forEach(step => {
                        const stepDiv = document.createElement('div');
                        stepDiv.className = 'tutorial-step';
                        stepDiv.innerHTML = `
                            <h3>${step.title}</h3>
                            ${step.content}
                        `;
                        DOMElements.tutorialSteps.appendChild(stepDiv);
                    });
                    
                    // Show only the first step initially
                    const allSteps = DOMElements.tutorialSteps.querySelectorAll('.tutorial-step');
                    allSteps.forEach((step, index) => {
                        step.style.display = index === 0 ? 'block' : 'none';
                    });
                    
                    // Reset tutorial state
                    UIState.currentTutorialStep = 0;
                    DOMElements.tutorialPrevBtn.disabled = true;
                    DOMElements.tutorialNextBtn.disabled = false;
                    DOMElements.tutorialProgress.textContent = `Step 1 of ${tutorialSteps.length}`;
                    
                    // Show the tutorial overlay
                    DOMElements.tutorialOverlay.style.display = 'flex';
                }
                
                function navigateTutorial(direction) {
                    const allSteps = DOMElements.tutorialSteps.querySelectorAll('.tutorial-step');
                    const totalSteps = allSteps.length;
                    
                    // Hide current step
                    allSteps[UIState.currentTutorialStep].style.display = 'none';
                    
                    // Update current step
                    UIState.currentTutorialStep += direction;
                    
                    // Show new current step
                    allSteps[UIState.currentTutorialStep].style.display = 'block';
                    
                    // Update buttons
                    DOMElements.tutorialPrevBtn.disabled = UIState.currentTutorialStep === 0;
                    DOMElements.tutorialNextBtn.disabled = UIState.currentTutorialStep === totalSteps - 1;
                    
                    // Update progress text
                    DOMElements.tutorialProgress.textContent = `Step ${UIState.currentTutorialStep + 1} of ${totalSteps}`;
                }
                
                function closeTutorial() {
                    DOMElements.tutorialOverlay.style.display = 'none';
                }
                
                // Initialization function
                function init() {
                    // Initial UI state
                    DOMElements.selectTeamBtn.disabled = true;
                    DOMElements.selectAllBtn.disabled = true;
                    DOMElements.showBracketBtn.disabled = true;
                    DOMElements.teeAssignmentTabButton.disabled = true;
                    
                    // Initialize tee assignment displays
                    createCourseLayout();
                    
                    // Add real-time validation
                    DOMElements.playerNameInput.addEventListener('input', validateNameInput);
                    DOMElements.playerHandicapInput.addEventListener('input', validateHandicapInput);
                    
                    // Set up settings listeners
                    DOMElements.balanceTeamsToggle.addEventListener('change', function() {
                        GolfApp.DataModel.updateSetting('balanceTeams', this.checked);
                    });
                    
                    DOMElements.maxHandicapDiff.addEventListener('change', function() {
                        GolfApp.DataModel.updateSetting('maxHandicapDiff', parseFloat(this.value) || 0);
                    });
                    
                    DOMElements.startFormatSelect.addEventListener('change', function() {
                        GolfApp.DataModel.updateSetting('startFormat', this.value);
                        updateTeeSheet();
                    });
                    
                    DOMElements.startTimeInput.addEventListener('change', function() {
                        GolfApp.DataModel.updateSetting('startTime', this.value);
                        updateTeeSheet();
                    });
                    
                    DOMElements.timeIntervalInput.addEventListener('change', function() {
                        GolfApp.DataModel.updateSetting('timeInterval', parseInt(this.value) || 10);
                        updateTeeSheet();
                    });
                    
                    // Set up tutorial events
                    DOMElements.helpButton.addEventListener('click', showTutorial);
                    DOMElements.tutorialPrevBtn.addEventListener('click', () => navigateTutorial(-1));
                    DOMElements.tutorialNextBtn.addEventListener('click', () => navigateTutorial(1));
                    DOMElements.tutorialCloseBtn.addEventListener('click', closeTutorial);
                    
                    // Set up tournament bracket event
                    DOMElements.showBracketBtn.addEventListener('click', createTournamentBracket);
                    
                    // Set up data persistence events
                    DOMElements.saveButton.addEventListener('click', function() {
                        const result = GolfApp.DataModel.saveToLocalStorage();
                        if (result.success) {
                            showError("Data saved successfully!");
                        } else {
                            showError(result.message);
                        }
                    });
                    
                    DOMElements.loadButton.addEventListener('click', function() {
                        const result = GolfApp.DataModel.loadFromLocalStorage();
                        if (result.success) {
                            // Update UI with loaded data
                            displayPlayers();
                            displayGroups();
                            displayTeams();
                            UIState.isGrouped = GolfApp.DataModel.getTeams().length > 0;
                            
                            // Enable/disable buttons based on loaded state
                            DOMElements.selectTeamBtn.disabled = !GolfApp.DataModel.canFormTeam();
                            DOMElements.selectAllBtn.disabled = !GolfApp.DataModel.canFormTeam();
                            DOMElements.draftStyleSelectBtn.disabled = !GolfApp.DataModel.canFormTeam(); // Enable/disable draft button
                            DOMElements.showBracketBtn.disabled = GolfApp.DataModel.getTeams().length < 2;
                            DOMElements.teeAssignmentTabButton.disabled = GolfApp.DataModel.getTeams().length === 0;
                        } else {
                            showError(result.message);
                        }
                    });
                }
                
                // Public API
                return {
                    init: init,
                    displayPlayers: displayPlayers,
                    displayGroups: displayGroups,
                    displayTeams: displayTeams,
                    updateHoleDisplays: updateHoleDisplays,
                    displayUnassignedTeams: displayUnassignedTeams,
                    updateTeeSheet: updateTeeSheet,
                    showError: showError,
                    clearError: clearError,
                    resetGroups: resetGroups,
                    enhancedTeamSelection: enhancedTeamSelection,
                    createTournamentBracket: createTournamentBracket,
                    initTeeAssignment: function() {
                        createCourseLayout();
                        displayUnassignedTeams();
                        updateTeeSheet();
                    },
                    getDOMElements: () => DOMElements,
                    getUIState: () => UIState
                };
            })();
            
            /**
             * App Controller Module
             * Coordinates between the data model and UI
             */
            GolfApp.AppController = (function() {
                // Add a player from input fields
                function addPlayer() {
                    GolfApp.UIController.clearError();
                    
                    const DOMElements = GolfApp.UIController.getDOMElements();
                    const nameInput = DOMElements.playerNameInput.value.trim();
                    const handicapInput = DOMElements.playerHandicapInput.value.trim();
                    
                    const result = GolfApp.DataModel.addPlayer(nameInput, handicapInput);
                    
                    if (!result.valid) {
                        if (result.errors.name) {
                            DOMElements.nameValidation.textContent = result.errors.name;
                            DOMElements.playerNameInput.classList.add('input-invalid');
                        }
                        
                        if (result.errors.handicap) {
                            DOMElements.handicapValidation.textContent = result.errors.handicap;
                            DOMElements.playerHandicapInput.classList.add('input-invalid');
                        }
                        
                        return;
                    }
                    
                    // Update UI
                    GolfApp.UIController.displayPlayers();
                    
                    // Clear inputs
                    DOMElements.playerNameInput.value = '';
                    DOMElements.playerHandicapInput.value = '';
                    DOMElements.playerNameInput.focus();
                    
                    // Reset groups if players are modified
                    if (GolfApp.UIController.getUIState().isGrouped) {
                        GolfApp.UIController.resetGroups();
                    }
                }
                
                // Group players into A, B, C, D based on handicaps
                function groupPlayers() {
                    GolfApp.UIController.clearError();
                    
                    const result = GolfApp.DataModel.groupPlayers();
                    
                    if (!result.success) {
                        GolfApp.UIController.showError(result.message);
                        return;
                    }
                    
                    // Update UI
                    GolfApp.UIController.displayGroups();
                    
                    // Update UI state
                    GolfApp.UIController.getUIState().isGrouped = true;
                    const DOMElements = GolfApp.UIController.getDOMElements();
                    DOMElements.selectTeamBtn.disabled = false;
                    DOMElements.selectAllBtn.disabled = false;
                    // Also enable draft style button if grouping was successful
                    DOMElements.draftStyleSelectBtn.disabled = false; 
                }
                
                // Select a team with players from each group (Original Random/Balanced Method)
                async function selectTeam() {
                    const UIState = GolfApp.UIController.getUIState();
                    const DOMElements = GolfApp.UIController.getDOMElements();
                    
                    if (!UIState.isGrouped) {
                        GolfApp.UIController.showError("Please group players first.");
                        return;
                    }
                    
                    const canForm = GolfApp.DataModel.canFormTeam();
                    if (!canForm) {
                        GolfApp.UIController.showError("Not enough players left to form a full team.");
                        DOMElements.selectTeamBtn.disabled = true;
                        DOMElements.selectAllBtn.disabled = true;
                        DOMElements.draftStyleSelectBtn.disabled = true; // Also disable draft button
                        return;
                    }
                    
                    // Temporarily disable selection buttons
                    DOMElements.selectTeamBtn.disabled = true;
                    DOMElements.selectAllBtn.disabled = true;
                    DOMElements.draftStyleSelectBtn.disabled = true;
                    
                    // Use enhanced team selection for pairing party
                    const result = await GolfApp.UIController.enhancedTeamSelection();
                    
                    // Handle result
                    if (!result.success) {
                        GolfApp.UIController.showError(result.message);
                        // Re-enable buttons if grouping still valid
                        const canFormMore = GolfApp.DataModel.canFormTeam();
                        DOMElements.selectTeamBtn.disabled = !canFormMore;
                        DOMElements.selectAllBtn.disabled = !canFormMore;
                        DOMElements.draftStyleSelectBtn.disabled = !canFormMore;
                        return;
                    }
                    
                    // Re-enable buttons if more teams can be formed
                    const canFormMore = GolfApp.DataModel.canFormTeam();
                    DOMElements.selectTeamBtn.disabled = !canFormMore;
                    DOMElements.selectAllBtn.disabled = !canFormMore;
                    DOMElements.draftStyleSelectBtn.disabled = !canFormMore;
                    
                    // Enable tee assignment tab if at least one team is created
                    if (GolfApp.DataModel.getTeams().length > 0) {
                        DOMElements.teeAssignmentTabButton.disabled = false;
                    }
                }
                
                // Auto-select all possible teams using the original method
                async function selectAllTeams() {
                    while (GolfApp.DataModel.canFormTeam()) {
                        await selectTeam();
                        // Add a small delay to make it visual
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }

                // Start the Draft Style team selection process
                function startDraftStyleSelection() {
                    const UIState = GolfApp.UIController.getUIState();
                    const DOMElements = GolfApp.UIController.getDOMElements();

                    if (!UIState.isGrouped) {
                        GolfApp.UIController.showError("Please group players first.");
                        return;
                    }

                    // Disable buttons during selection
                    DOMElements.selectTeamBtn.disabled = true;
                    DOMElements.selectAllBtn.disabled = true;
                    DOMElements.draftStyleSelectBtn.disabled = true;

                    const result = GolfApp.DataModel.draftStyleTeamSelection();

                    if (result.success) {
                        GolfApp.UIController.showError(`${result.numTeamsCreated} teams created using Draft Style.`);
                        GolfApp.UIController.displayGroups(); // Update groups display (players removed)
                        GolfApp.UIController.displayTeams(); // Update teams display

                        // Re-enable buttons if more teams can be formed (might not be possible with draft)
                        const canFormMore = GolfApp.DataModel.canFormTeam();
                        DOMElements.selectTeamBtn.disabled = !canFormMore;
                        DOMElements.selectAllBtn.disabled = !canFormMore;
                        DOMElements.draftStyleSelectBtn.disabled = !canFormMore; // Disable if no more full drafts possible

                        // Enable tee assignment if teams exist
                        if (GolfApp.DataModel.getTeams().length > 0) {
                            DOMElements.teeAssignmentTabButton.disabled = false;
                        }
                    } else {
                        GolfApp.UIController.showError(result.message);
                        // Re-enable buttons on failure if grouping still valid
                        const canForm = GolfApp.DataModel.canFormTeam();
                        DOMElements.selectTeamBtn.disabled = !canForm;
                        DOMElements.selectAllBtn.disabled = !canForm;
                        DOMElements.draftStyleSelectBtn.disabled = !canForm;
                    }
                }
                
                // Handle file upload for CSV import
                function handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const contents = e.target.result;
                        processCSV(contents);
                    };
                    reader.readAsText(file);
                }
                
                // Process CSV data
                function processCSV(csv) {
                    GolfApp.UIController.clearError();
                    
                    const result = GolfApp.DataModel.processCSV(csv);
                    
                    if (result.errors.length > 0) {
                        GolfApp.UIController.showError(`CSV Import Error: ${result.errors[0]}`);
                        return;
                    }
                    
                    // Add imported players to our player list
                    const players = GolfApp.DataModel.getPlayers().concat(result.players);
                    GolfApp.DataModel.setPlayers(players);
                    
                    // Update UI
                    GolfApp.UIController.displayPlayers();
                    
                    // Reset groups if players are modified
                    if (GolfApp.UIController.getUIState().isGrouped) {
                        GolfApp.UIController.resetGroups();
                    }
                    
                    // Clear file input
                    GolfApp.UIController.getDOMElements().fileInput.value = '';
                }
                
                // Reset all data
                function resetAll() {
                    GolfApp.DataModel.resetAll();
                    GolfApp.UIController.resetGroups();
                    GolfApp.UIController.displayPlayers();
                }
                
                // Initialize tee assignment
                function initTeeAssignment() {
                    GolfApp.UIController.initTeeAssignment();
                }
                
                // Auto-assign teams to holes
                function autoAssignTeams() {
                    const result = GolfApp.DataModel.autoAssignTeams();
                    
                    if (result.success) {
                        GolfApp.UIController.updateHoleDisplays();
                        GolfApp.UIController.displayUnassignedTeams();
                        GolfApp.UIController.updateTeeSheet();
                    } else {
                        GolfApp.UIController.showError(result.message);
                    }
                }
                
                // Randomly assign teams to holes
                function randomizeTeamAssignments() {
                    const result = GolfApp.DataModel.randomizeTeamAssignments();
                    
                    if (result.success) {
                        GolfApp.UIController.updateHoleDisplays();
                        GolfApp.UIController.displayUnassignedTeams();
                        GolfApp.UIController.updateTeeSheet();
                    } else {
                        GolfApp.UIController.showError(result.message);
                    }
                }
                
                // Reset hole assignments
                function resetAssignments() {
                    GolfApp.DataModel.setHoleAssignments({});
                    GolfApp.UIController.getUIState().selectedTeamId = null;
                    GolfApp.UIController.updateHoleDisplays();
                    GolfApp.UIController.displayUnassignedTeams();
                    GolfApp.UIController.updateTeeSheet();
                }
                
                // Print tee sheet
                function printTeeSheet() {
                    window.print();
                }
                
                // Setup event listeners
                function setupEventListeners() {
                    const DOMElements = GolfApp.UIController.getDOMElements();
                    
                    // Tab navigation
                    DOMElements.tabButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const tabId = this.getAttribute('data-tab');
                            
                            // If teams tab is clicked but no teams exist yet
                            if (tabId === 'teeAssignmentTab' && GolfApp.DataModel.getTeams().length === 0) {
                                GolfApp.UIController.showError("Please create teams first before assigning tee times.");
                                return;
                            }
                            
                            // Deactivate all tabs
                            DOMElements.tabButtons.forEach(btn => btn.classList.remove('active'));
                            DOMElements.tabContents.forEach(content => content.classList.remove('active'));
                            
                            // Activate selected tab
                            this.classList.add('active');
                            document.getElementById(tabId).classList.add('active');
                            
                            // If tee assignment tab is clicked, initialize hole assignments
                            if (tabId === 'teeAssignmentTab') {
                                initTeeAssignment();
                            }
                        });
                    });
                    
                    // Player input events
                    DOMElements.addPlayerBtn.addEventListener('click', addPlayer);
                    DOMElements.resetBtn.addEventListener('click', resetAll);
                    DOMElements.fileInput.addEventListener('change', handleFileUpload);
                    
                    // Allow Enter key to add player
                    DOMElements.playerHandicapInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addPlayer();
                        }
                    });
                    
                    // Group and team selection events
                    DOMElements.groupPlayersBtn.addEventListener('click', groupPlayers);
                    DOMElements.selectTeamBtn.addEventListener('click', selectTeam);
                    DOMElements.selectAllBtn.addEventListener('click', selectAllTeams);
                    DOMElements.draftStyleSelectBtn.addEventListener('click', startDraftStyleSelection); // Added listener for draft button
                    
                    // Tee assignment events
                    DOMElements.autoAssignBtn.addEventListener('click', autoAssignTeams);
                    DOMElements.randomAssignBtn.addEventListener('click', randomizeTeamAssignments);
                    DOMElements.resetAssignmentBtn.addEventListener('click', resetAssignments);
                    DOMElements.printTeeSheetBtn.addEventListener('click', printTeeSheet);
                }
                
                // Public API
                return {
                    init: function() {
                        // Initialize UI controller
                        GolfApp.UIController.init();
                        
                        // Set up event listeners
                        setupEventListeners();
                        
                        // Try to load saved data
                        const loadResult = GolfApp.DataModel.loadFromLocalStorage();
                        if (loadResult.success) {
                            // Update UI with loaded data
                            GolfApp.UIController.displayPlayers();
                            GolfApp.UIController.displayGroups();
                            GolfApp.UIController.displayTeams();
                            GolfApp.UIController.getUIState().isGrouped = GolfApp.DataModel.getTeams().length > 0;
                            
                            // Enable/disable buttons based on loaded state
                            const DOMElements = GolfApp.UIController.getDOMElements();
                            DOMElements.selectTeamBtn.disabled = !GolfApp.DataModel.canFormTeam();
                            DOMElements.selectAllBtn.disabled = !GolfApp.DataModel.canFormTeam();
                            DOMElements.draftStyleSelectBtn.disabled = !GolfApp.DataModel.canFormTeam(); // Enable/disable draft button
                            DOMElements.showBracketBtn.disabled = GolfApp.DataModel.getTeams().length < 2;
                            DOMElements.teeAssignmentTabButton.disabled = GolfApp.DataModel.getTeams().length === 0;
                        }
                    }
                };
            })();
            
            // Initialize the application when the DOM is ready
            document.addEventListener('DOMContentLoaded', GolfApp.AppController.init);
        })();
    </script>
</body>
</html>
